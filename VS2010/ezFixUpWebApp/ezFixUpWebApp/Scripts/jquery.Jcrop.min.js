(function(a){a.Jcrop=function(y,m){var y=y,m=m;if(typeof y!=="object")y=a(y)[0];if(typeof m!=="object")m={};if(!("trackDocument"in m)){m.trackDocument=a.browser.msie?false:true;if(a.browser.msie&&a.browser.version.split(".")[0]=="8")m.trackDocument=true}if(!("keySupport"in m))m.keySupport=a.browser.msie?false:true;var ib={trackDocument:false,baseClass:"jcrop",addClass:null,bgColor:"black",bgOpacity:.6,borderOpacity:.4,handleOpacity:.5,handlePad:5,handleSize:9,handleOffset:5,edgeMargin:14,aspectRatio:0,keySupport:true,cornerHandles:true,sideHandles:true,drawBorders:true,dragEdges:true,boxWidth:0,boxHeight:0,boundary:8,animationDelay:20,swingSpeed:3,allowSelect:true,allowMove:true,allowResize:true,minSelect:[0,0],maxSize:[0,0],minSize:[0,0],onChange:function(){},onSelect:function(){}},b=ib;P(m);var o=a(y),j=o.clone().removeAttr("id").css({position:"absolute"});j.width(o.width());j.height(o.height());o.after(j).hide();lb(j,b.boxWidth,b.boxHeight);var g=j.width(),f=j.height(),K=a("<div />").width(g).height(f).addClass(A("holder")).css({position:"relative",backgroundColor:b.bgColor}).insertAfter(o).append(j);b.addClass&&K.addClass(b.addClass);var U=a("<img />").attr("src",j.attr("src")).css("position","absolute").width(g).height(f),F=a("<div />").width(q(100)).height(q(100)).css({zIndex:310,position:"absolute",overflow:"hidden"}).append(U),p=a("<div />").width(q(100)).height(q(100)).css("zIndex",320),D=a("<div />").css({position:"absolute",zIndex:300}).insertBefore(j).append(F,p),C=b.boundary,u=O().width(g+C*2).height(f+C*2).css({position:"absolute",top:c(-C),left:c(-C),zIndex:290}).mousedown(Z),s,t,v,x,k,l,mb=true,z=J(j),r,T,nb,R,Q,d=function(){var a=0,c=0,e=0,d=0,o,p;function u(b){var b=n(b);e=a=b[0];d=c=b[1]}function r(a){var a=n(a);o=a[0]-e;p=a[1]-d;e=a[0];d=a[1]}function z(){return[o,p]}function q(i){var b=i[0],h=i[1];if(0>a+b)b-=b+a;if(0>c+h)h-=h+c;if(f<d+h)h+=f-(d+h);if(g<e+b)b+=g-(e+b);a+=b;e+=b;c+=h;d+=h}function y(b){var a=j();switch(b){case"ne":return[a.x2,a.y];case"nw":return[a.x,a.y];case"se":return[a.x2,a.y2];case"sw":return[a.x,a.y2]}}function j(){if(!b.aspectRatio)return A();var o=b.aspectRatio,q=b.minSize[0]/k,y=b.minSize[1]/l,p=b.maxSize[0]/k,t=b.maxSize[1]/l,s=e-a,r=d-c,v=Math.abs(s),u=Math.abs(r),x=v/u,j,n;if(p==0)p=g*10;if(t==0)t=f*10;if(x<o){n=d;w=u*o;j=s<0?a-w:w+a;if(j<0){j=0;h=Math.abs((j-a)/o);n=r<0?c-h:h+c}else if(j>g){j=g;h=Math.abs((j-a)/o);n=r<0?c-h:h+c}}else{j=e;h=v/o;n=r<0?c-h:c+h;if(n<0){n=0;w=Math.abs((n-c)*o);j=s<0?a-w:w+a}else if(n>f){n=f;w=Math.abs(n-c)*o;j=s<0?a-w:w+a}}if(j>a){if(j-a<q)j=a+q;else if(j-a>p)j=a+p;if(n>c)n=c+(j-a)/o;else n=c-(j-a)/o}else if(j<a){if(a-j<q)j=a-q;else if(a-j>p)j=a-p;if(n>c)n=c+(a-j)/o;else n=c-(a-j)/o}if(j<0){a-=j;j=0}else if(j>g){a-=j-g;j=g}if(n<0){c-=n;n=0}else if(n>f){c-=n-f;n=f}return last=m(i(a,c,j,n))}function n(a){if(a[0]<0)a[0]=0;if(a[1]<0)a[1]=0;if(a[0]>g)a[0]=g;if(a[1]>f)a[1]=f;return[a[0],a[1]]}function i(a,c,b,d){var e=a,f=b,g=c,h=d;if(b<a){e=b;f=a}if(d<c){g=d;h=c}return[Math.round(e),Math.round(g),Math.round(f),Math.round(h)]}function A(){var h=e-a,j=d-c;if(s&&Math.abs(h)>s)e=h>0?a+s:a-s;if(t&&Math.abs(j)>t)d=j>0?c+t:c-t;if(x&&Math.abs(j)<x)d=j>0?c+x:c-x;if(v&&Math.abs(h)<v)e=h>0?a+v:a-v;if(a<0){e-=a;a-=a}if(c<0){d-=c;c-=c}if(e<0){a-=e;e-=e}if(d<0){c-=d;d-=d}if(e>g){var b=e-g;a-=b;e-=b}if(d>f){var b=d-f;c-=b;d-=b}if(a>g){var b=a-f;d-=b;c-=b}if(c>f){var b=c-f;d-=b;c-=b}return m(i(a,c,e,d))}function m(a){return{x:a[0],y:a[1],x2:a[2],y2:a[3],w:a[2]-a[0],h:a[3]-a[1]}}return{flipCoords:i,setPressed:u,setCurrent:r,getOffset:z,moveOffset:q,getCorner:y,getFixed:j}}(),e=function(){var N,P,M,m,z=370,o={},e={},g=false,f=b.handleOffset;if(b.drawBorders)o={top:l("hline").css("top",a.browser.msie?c(-1):c(0)),bottom:l("hline"),left:l("vline"),right:l("vline")};if(b.dragEdges){e.t=k("n");e.b=k("s");e.r=k("e");e.l=k("w")}b.sideHandles&&r(["n","s","e","w"]);b.cornerHandles&&r(["sw","nw","ne","se"]);function l(d){var c=a("<div />").css({position:"absolute",opacity:b.borderOpacity}).addClass(A(d));F.append(c);return c}function v(b,d){var c=a("<div />").mousedown(L(b)).css({cursor:b+"-resize",position:"absolute",zIndex:d});p.append(c);return c}function B(a){return v(a,z++).css({top:c(-f+1),left:c(-f+1),opacity:b.handleOpacity}).addClass(A("handle"))}function k(a){var g=b.handleSize,e=f,d=g,h=g,j=e,i=e;switch(a){case"n":case"s":h=q(100);break;case"e":case"w":d=q(100)}return v(a,z++).width(h).height(d).css({top:c(-j+1),left:c(-i+1)})}function r(a){for(i in a)e[a[i]]=B(a[i])}function n(d){var h=Math.round(d.h/2-f),g=Math.round(d.w/2-f),i=west=-f+1,b=d.w-f,a=d.h-f,j,k;"e"in e&&e.e.css({top:c(h),left:c(b)})&&e.w.css({top:c(h)})&&e.s.css({top:c(a),left:c(g)})&&e.n.css({left:c(g)});"ne"in e&&e.ne.css({left:c(b)})&&e.se.css({top:c(a),left:c(b)})&&e.sw.css({top:c(a)});"b"in e&&e.b.css({top:c(a)})&&e.r.css({left:c(b)})}function G(a,b){U.css({top:c(-b),left:c(-a)});D.css({top:c(b),left:c(a)})}function H(b,a){D.width(b).height(a)}function w(){var a=d.getFixed();d.setPressed([a.x,a.y]);d.setCurrent([a.x2,a.y2]);t()}function t(){if(m)return y()}function y(){var a=d.getFixed();H(a.w,a.h);G(a.x,a.y);b.drawBorders&&o.right.css({left:c(a.w-1)})&&o.bottom.css({top:c(a.h-1)});g&&n(a);m||K();b.onChange(I(a))}function K(){D.show();j.css("opacity",b.bgOpacity);m=true}function E(){h();D.hide();j.css("opacity",1);m=false}function C(){if(g){n(d.getFixed());p.show()}}function s(){g=true;if(b.allowResize){n(d.getFixed());p.show();return true}}function h(){g=false;p.hide()}function u(a){(R=a)?h():s()}function J(){u(false);w()}var x=O().mousedown(L("move")).css({cursor:"move",position:"absolute",zIndex:360});F.append(x);h();return{updateVisible:t,update:y,release:E,refresh:w,setCursor:function(a){x.css("cursor",a)},enableHandles:s,enableOnly:function(){g=true},showHandles:C,disableHandles:h,animMode:u,done:J}}(),n=function(){var h=function(){},g=function(){},f=b.trackDocument;!f&&u.mousemove(e).mouseup(c).mouseout(c);function l(){u.css({zIndex:450});f&&a(document).mousemove(e).mouseup(c)}function m(){u.css({zIndex:290});f&&a(document).unbind("mousemove",e).unbind("mouseup",c)}function e(a){h(B(a))}function c(a){a.preventDefault();a.stopPropagation();if(r){r=false;g(B(a));b.onSelect(I(d.getFixed()));m();h=function(){};g=function(){}}return false}function i(b,a){r=true;h=b;g=a;l();return false}function k(a){u.css("cursor",a)}j.before(u);return{activateHandlers:i,setCursor:k}}(),H=function(){var c=a('<input type="radio" />').css({position:"absolute",left:"-30px"}).keypress(i).blur(k),h=a("<div />").css({position:"absolute",overflow:"hidden"}).append(c);function g(){if(b.keySupport){c.show();c.focus()}}function k(){c.hide()}function f(a,c,f){if(b.allowMove){d.moveOffset([c,f]);e.updateVisible()}a.preventDefault();a.stopPropagation()}function i(a){if(a.ctrlKey)return true;Q=a.shiftKey?true:false;var b=Q?10:1;switch(a.keyCode){case 37:f(a,-b,0);break;case 39:f(a,b,0);break;case 38:f(a,0,-b);break;case 40:f(a,0,b);break;case 27:e.release();break;case 9:return true}return nothing(a)}b.keySupport&&h.insertBefore(j);return{watchKeys:g}}();function c(a){return""+parseInt(a)+"px"}function q(a){return""+parseInt(a)+"%"}function A(a){return b.baseClass+"-"+a}function J(c){var b=a(c).offset();return[b.left,b.top]}function B(a){return[a.pageX-z[0],a.pageY-z[1]]}function jb(a){if(a!=T){n.setCursor(a);T=a}}function Y(a,e){z=J(j);n.setCursor(a=="move"?a:a+"-resize");if(a=="move")return n.activateHandlers(ab(e),G);var f=d.getFixed(),b=M(a),c=d.getCorner(M(b));d.setPressed(d.getCorner(b));d.setCurrent(c);n.activateHandlers(W(a,f),G)}function W(c,a){return function(f){if(!b.aspectRatio)switch(c){case"e":f[1]=a.y2;break;case"w":f[1]=a.y2;break;case"n":f[0]=a.x2;break;case"s":f[0]=a.x2}else switch(c){case"e":f[1]=a.y+1;break;case"w":f[1]=a.y+1;break;case"n":f[0]=a.x+1;break;case"s":f[0]=a.x+1}d.setCurrent(f);e.update()}}function ab(b){var a=b;H.watchKeys();return function(b){d.moveOffset([b[0]-a[0],b[1]-a[1]]);a=b;e.update()}}function M(a){switch(a){case"n":return"sw";case"s":return"nw";case"e":return"nw";case"w":return"ne";case"ne":return"sw";case"nw":return"se";case"se":return"nw";case"sw":return"ne"}}function L(a){return function(c){if(b.disabled)return false;if(a=="move"&&!b.allowMove)return false;r=true;Y(a,B(c));c.stopPropagation();c.preventDefault();return false}}function lb(a,e,d){var c=a.width(),b=a.height();if(c>e&&e>0){c=e;b=e/a.width()*a.height()}if(b>d&&d>0){b=d;c=d/a.height()*a.width()}k=a.width()/c;l=a.height()/b;a.width(c).height(b)}function I(a){return{x:parseInt(a.x*k),y:parseInt(a.y*l),x2:parseInt(a.x2*k),y2:parseInt(a.y2*l),w:parseInt(a.w*k),h:parseInt(a.h*l)}}function G(){var a=d.getFixed();if(a.w>b.minSelect[0]&&a.h>b.minSelect[1]){e.enableHandles();e.done()}else e.release();n.setCursor(b.allowSelect?"crosshair":"default")}function Z(a){if(b.disabled)return false;if(!b.allowSelect)return false;r=true;z=J(j);e.disableHandles();jb("crosshair");var c=B(a);d.setPressed(c);n.activateHandlers(eb,G);H.watchKeys();e.update();a.stopPropagation();a.preventDefault();return false}function eb(a){d.setCurrent(a);e.update()}function O(){var b=a("<div></div>").addClass(A("tracker"));a.browser.msie&&b.css({opacity:0,backgroundColor:"white"});return b}function hb(g){var u=g[0]/k,v=g[1]/l,j=g[2]/k,m=g[3]/l;if(R)return;var f=d.flipCoords(u,v,j,m),h=d.getFixed(),a=initcr=[h.x,h.y,h.x2,h.y2],p=b.animationDelay,w=a[0],x=a[1],j=a[2],m=a[3],q=f[0]-initcr[0],s=f[1]-initcr[1],r=f[2]-initcr[2],t=f[3]-initcr[3],c=0,o=b.swingSpeed;e.animMode(true);var n=function(){return function(){c+=(100-c)/o;a[0]=w+c/100*q;a[1]=x+c/100*s;a[2]=j+c/100*r;a[3]=m+c/100*t;if(c<100)i();else e.done();if(c>=99.8)c=100;N(a)}}();function i(){window.setTimeout(n,p)}i()}function S(a){N([a[0]/k,a[1]/l,a[2]/k,a[3]/l])}function N(a){d.setPressed([a[0],a[1]]);d.setCurrent([a[2],a[3]]);e.update()}function P(c){if(typeof c!="object")c={};b=a.extend(b,c);if(typeof b.onChange!=="function")b.onChange=function(){};if(typeof b.onSelect!=="function")b.onSelect=function(){}}function gb(){return I(d.getFixed())}function fb(){return d.getFixed()}function X(a){P(a);E()}function bb(){b.disabled=true;e.disableHandles();e.setCursor("default");n.setCursor("default")}function db(){b.disabled=false;E()}function cb(){e.done();n.activateHandlers(null,null)}function kb(){K.remove();o.show()}function E(a){b.allowResize?a?e.enableOnly():e.enableHandles():e.disableHandles();n.setCursor(b.allowSelect?"crosshair":"default");e.setCursor(b.allowMove?"move":"default");K.css("backgroundColor",b.bgColor);if("setSelect"in b){S(m.setSelect);e.done();delete b.setSelect}if("trueSize"in b){k=b.trueSize[0]/g;l=b.trueSize[1]/f}s=b.maxSize[0]||0;t=b.maxSize[1]||0;v=b.minSize[0]||0;x=b.minSize[1]||0;if("outerImage"in b){j.attr("src",b.outerImage);delete b.outerImage}e.refresh()}p.hide();E(true);var V={animateTo:hb,setSelect:S,setOptions:X,tellSelect:gb,tellScaled:fb,disable:bb,enable:db,cancel:cb,focus:H.watchKeys,getBounds:function(){return[g*k,f*l]},getWidgetSize:function(){return[g,f]},release:e.release,destroy:kb};o.data("Jcrop",V);return V};a.fn.Jcrop=function(b){function c(c){var e=b.useImg||c.src,d=new Image;d.onload=function(){a.Jcrop(c,b)};d.src=e}if(typeof b!=="object")b={};this.each(function(){if(a(this).data("Jcrop"))if(b=="api")return a(this).data("Jcrop");else a(this).data("Jcrop").setOptions(b);else c(this)});return this}})(jQuery);