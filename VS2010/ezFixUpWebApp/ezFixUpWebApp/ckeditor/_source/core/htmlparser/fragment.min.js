CKEDITOR.htmlParser.fragment=function(){this.children=[],this.parent=null,this._={isBlockLike:!0,hasInlineStarted:!1}},function(){var t={colgroup:1,dd:1,dt:1,li:1,option:1,p:1,td:1,tfoot:1,th:1,thead:1,tr:1},i=CKEDITOR.tools.extend({table:1,ul:1,ol:1,dl:1},CKEDITOR.dtd.table,CKEDITOR.dtd.ul,CKEDITOR.dtd.ol,CKEDITOR.dtd.dl),n=CKEDITOR.dtd.$list,r=CKEDITOR.dtd.$listItem;CKEDITOR.htmlParser.fragment.fromHtml=function(u,f){function p(n){var t;if(o.length>0)for(t=0;t<o.length;t++){var i=o[t],r=i.name,u=CKEDITOR.dtd[r],f=e.name&&CKEDITOR.dtd[e.name];f&&!f[r]||n&&u&&!u[n]&&CKEDITOR.dtd[n]||(i=i.clone(),i.parent=e,e=i,o.splice(t,1),t--)}}function c(n,t,i){var u,h,c,o,r,l;if(t=t||e||v,f&&!t.type&&(u=n.attributes&&(h=n.attributes._cke_real_element_type)?h:n.name,u&&!(u in CKEDITOR.dtd.$body)&&!(u in CKEDITOR.dtd.$nonBodyContent))){c=e,e=t;s.onTagOpen(f,{});t=e,i&&(e=c)}n._.isBlockLike&&n.name!="pre"&&(o=n.children.length,r=n.children[o-1],r&&r.type==CKEDITOR.NODE_TEXT&&((l=CKEDITOR.tools.rtrim(r.value))?r.value=l:n.children.length=o-1)),t.add(n),n.returnPoint&&(e=n.returnPoint,delete n.returnPoint)}var s=new CKEDITOR.htmlParser,v=new CKEDITOR.htmlParser.fragment,o=[],e=v,l=!1,a,h,y;for(s.onTagOpen=function(u,f,h){var v=new CKEDITOR.htmlParser.element(u,f),y,b,k,d,g,w;if(v.isUnknown&&h&&(v.isEmpty=!0),CKEDITOR.dtd.$removeEmpty[u]){o.push(v);return}if(u=="pre")l=!0;else if(u=="br"&&l){e.add(new CKEDITOR.htmlParser.text("\n"));return}if(y=e.name,b=y&&(CKEDITOR.dtd[y]||(e._.isBlockLike?CKEDITOR.dtd.div:CKEDITOR.dtd.span)),b&&!v.isUnknown&&!e.isUnknown&&!b[u]&&(k=!1,u in n&&y in n?(g=e.children,w=g[g.length-1],w&&w.name in r||c(w=new CKEDITOR.htmlParser.element("li"),e),a=e,d=w):u==y?c(e,e.parent):(i[y]?a||(a=e):(c(e,e.parent,!0),t[y]||o.unshift(e)),k=!0),e=d?d:e.returnPoint||e.parent,k)){s.onTagOpen.apply(this,arguments);return}p(u),v.parent=e,v.returnPoint=a,a=0,v.isEmpty?c(v):e=v},s.onTagClose=function(n){for(var u,i=o.length-1;i>=0;i--)if(n==o[i].name){o.splice(i,1);return}for(var r=[],s=[],t=e;t.type&&t.name!=n;)t._.isBlockLike||s.unshift(t),r.push(t),t=t.parent;if(t.type){for(i=0;i<r.length;i++)u=r[i],c(u,u.parent);e=t,e.name=="pre"&&(l=!1),c(t,t.parent),t==e&&(e=e.parent),o=o.concat(s)}n=="body"&&(f=!1)},s.onText=function(n){if(e._.hasInlineStarted||l||(n=CKEDITOR.tools.ltrim(n),n.length!==0)){if(p(),f&&(!e.type||e.name=="body")&&CKEDITOR.tools.trim(n))this.onTagOpen(f,{});l||(n=n.replace(/[\t\r\n ]{2,}|[\t\r\n]/g," ")),e.add(new CKEDITOR.htmlParser.text(n))}},s.onCDATA=function(n){e.add(new CKEDITOR.htmlParser.cdata(n))},s.onComment=function(n){e.add(new CKEDITOR.htmlParser.comment(n))},s.parse(u);e.type;){if(h=e.parent,y=e,f&&(!h.type||h.name=="body")&&!CKEDITOR.dtd.$body[y.name]){e=h;s.onTagOpen(f,{});h=e}h.add(y),e=h}return v},CKEDITOR.htmlParser.fragment.prototype={add:function(n){var i=this.children.length,t=i>0&&this.children[i-1]||null;if(t){if(n._.isBlockLike&&t.type==CKEDITOR.NODE_TEXT&&(t.value=CKEDITOR.tools.rtrim(t.value),t.value.length===0)){this.children.pop(),this.add(n);return}t.next=n}n.previous=t,n.parent=this,this.children.push(n),this._.hasInlineStarted=n.type==CKEDITOR.NODE_TEXT||n.type==CKEDITOR.NODE_ELEMENT&&!n._.isBlockLike},writeHtml:function(n,t){var i;this.filterChildren=function(){var n=new CKEDITOR.htmlParser.basicWriter,r;this.writeChildrenHtml.call(this,n,t,!0),r=n.getHtml(),this.children=new CKEDITOR.htmlParser.fragment.fromHtml(r).children,i=1},!this.name&&t&&t.onFragment(this),this.writeChildrenHtml(n,i?null:t)},writeChildrenHtml:function(n,t){for(var i=0;i<this.children.length;i++)this.children[i].writeHtml(n,t)}}}();