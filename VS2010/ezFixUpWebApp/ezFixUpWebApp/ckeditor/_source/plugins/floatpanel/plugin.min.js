CKEDITOR.plugins.add("floatpanel",{requires:["panel"]}),function(){function i(t,i,r,u,f){var o=i.getUniqueId()+"-"+r.getUniqueId()+"-"+t.skinName+"-"+t.lang.dir+(t.uiColor&&"-"+t.uiColor||"")+(u.css&&"-"+u.css||"")+(f&&"-"+f||""),e=n[o];return e||(e=n[o]=new CKEDITOR.ui.panel(i,u),e.element=r.append(CKEDITOR.dom.element.createFromHtml(e.renderHtml(t),i)),e.element.setStyles({display:"none",position:"absolute"})),e}var n={},t=!1;CKEDITOR.ui.floatPanel=CKEDITOR.tools.createClass({$:function(n,t,r,u){r.forceIFrame=!0;var f=t.getDocument(),e=i(n,f,t,r,u||0),o=e.element,s=o.getFirst().getFirst();this.element=o,this._={panel:e,parentElement:t,definition:r,document:f,iframe:s,children:[],dir:n.lang.dir}},proto:{addBlock:function(n,t){return this._.panel.addBlock(n,t)},addListBlock:function(n,t){return this._.panel.addListBlock(n,t)},getBlock:function(n){return this._.panel.getBlock(n)},showBlock:function(n,i,r,u,f){var o=this._.panel,v=o.showBlock(n),a;this.allowBlur(!1),t=!0;var s=this.element,h=this._.iframe,y=this._.definition,p=i.getDocumentPosition(s.getDocument()),c=this._.dir=="rtl",e=p.x+(u||0),l=p.y+(f||0);if(c&&(r==1||r==4)?e+=i.$.offsetWidth:c||r!=2&&r!=3||(e+=i.$.offsetWidth-1),(r==3||r==4)&&(l+=i.$.offsetHeight-1),this._.panel._.offsetParentId=i.getId(),s.setStyles({top:l+"px",left:"-3000px",opacity:"0",display:""}),!this._.blurSet){a=CKEDITOR.env.ie?h:new CKEDITOR.dom.window(h.$.contentWindow),CKEDITOR.event.useCapture=!0;a.on("blur",function(n){if(this.allowBlur()){var i=n.data.getTarget(),r=i.getWindow&&i.getWindow();r&&r.equals(a)||!this.visible||this._.activeChild||t||this.hide()}},this);a.on("focus",function(){this._.focused=!0,this.hideChild(),this.allowBlur(!0)},this);CKEDITOR.event.useCapture=!1,this._.blurSet=1}o.onEscape=CKEDITOR.tools.bind(function(){this.onEscape&&this.onEscape()},this),CKEDITOR.tools.setTimeout(function(){c&&(e-=s.$.offsetWidth);var n=CKEDITOR.tools.bind(function(){var n,t;v.autoSize?(n=s.getFirst(),t=v.element.$.scrollHeight,CKEDITOR.env.ie&&CKEDITOR.env.quirks&&t>0&&(t+=(n.$.offsetHeight||0)-(n.$.clientHeight||0)),n.setStyle("height",t+"px"),o._.currentBlock.element.setStyle("display","none").removeStyle("display")):s.getFirst().removeStyle("height");var r=o.element,u=r.getWindow(),f=u.getScrollPosition(),h=u.getViewPaneSize(),i={height:r.$.offsetHeight,width:r.$.offsetWidth};(c?e<0:e+i.width>h.width+f.x)&&(e+=i.width*(c?1:-1)),l+i.height>h.height+f.y&&(l-=i.height),s.setStyles({top:l+"px",left:e+"px",opacity:"1"})},this);o.isLoaded?n():o.onLoad=n,CKEDITOR.tools.setTimeout(function(){if(y.voiceLabel&&CKEDITOR.env.gecko){var n=h.getParent();n.setAttribute("role","region"),n.setAttribute("title",y.voiceLabel),h.setAttribute("role","region"),h.setAttribute("title"," ")}h.$.contentWindow.focus(),this.allowBlur(!0)},0,this)},0,this),this.visible=1,this.onShow&&this.onShow.call(this),t=!1},hide:function(){this.visible&&(!this.onHide||this.onHide.call(this)!==!0)&&(this.hideChild(),this.element.setStyle("display","none"),this.visible=0)},allowBlur:function(n){var t=this._.panel;return n!=undefined&&(t.allowBlur=n),t.allowBlur},showAsChild:function(n,t,i,r,u,f){(this._.activeChild!=n||n._.panel._.offsetParentId!=i.getId())&&(this.hideChild(),n.onHide=CKEDITOR.tools.bind(function(){CKEDITOR.tools.setTimeout(function(){this._.focused||this.hide()},0,this)},this),this._.activeChild=n,this._.focused=!1,n.showBlock(t,i,r,u,f),(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie8&&CKEDITOR.env.ie6Compat)&&setTimeout(function(){n.element.getChild(0).$.style.cssText+=""},100))},hideChild:function(){var n=this._.activeChild;n&&(delete n.onHide,delete this._.activeChild,n.hide())}}});CKEDITOR.on("instanceDestroyed",function(){var i=CKEDITOR.tools.isEmpty(CKEDITOR.instances),r,t;for(r in n)t=n[r],i?t.destroy():t.element.hide();i&&(n={})})}();