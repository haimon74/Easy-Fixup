(function(){function n(n,t){var i=t.block||t.blockLimit;return!i||i.getName()=="body"?CKEDITOR.TRISTATE_OFF:i.getAscendant("blockquote",!0)?CKEDITOR.TRISTATE_ON:CKEDITOR.TRISTATE_OFF}function t(t){var i=t.editor,r=i.getCommand("blockquote");r.state=n(i,t.data.path),r.fire("state")}function i(n){for(var t=0,r=n.getChildCount(),i;t<r&&(i=n.getChild(t));t++)if(i.type==CKEDITOR.NODE_ELEMENT&&i.isBlockBoundary())return!1;return!0}var r={exec:function(n){var et=n.getCommand("blockquote").state,k=n.getSelection(),h=k&&k.getRanges()[0],l,y,p,f,it,t,u,w,d,c,g,s,ot,rt,o,e,nt,a,ut,v,tt,b,r,ft,st,ht;if(h){if(l=k.createBookmarks(),CKEDITOR.env.ie){if(y=l[0].startNode,p=l[0].endNode,y&&y.getParent().getName()=="blockquote")for(f=y;f=f.getNext();)if(f.type==CKEDITOR.NODE_ELEMENT&&f.isBlockBoundary()){y.move(f,!0);break}if(p&&p.getParent().getName()=="blockquote")for(f=p;f=f.getPrevious();)if(f.type==CKEDITOR.NODE_ELEMENT&&f.isBlockBoundary()){p.move(f);break}}if(it=h.createIterator(),et==CKEDITOR.TRISTATE_OFF){for(u=[];t=it.getNextParagraph();)u.push(t);for(u.length<1&&(w=n.document.createElement(n.config.enterMode==CKEDITOR.ENTER_P?"p":"div"),d=l.shift(),h.insertNode(w),w.append(new CKEDITOR.dom.text("ï»¿",n.document)),h.moveToBookmark(d),h.selectNodeContents(w),h.collapse(!0),d=h.createBookmark(),u.push(w),l.unshift(d)),c=u[0].getParent(),g=[],s=0;s<u.length;s++)t=u[s],c=c.getCommonAncestor(t.getParent());for(ot={table:1,tbody:1,tr:1,ol:1,ul:1};ot[c.getName()];)c=c.getParent();for(rt=null;u.length>0;){for(t=u.shift();!t.getParent().equals(c);)t=t.getParent();t.equals(rt)||g.push(t),rt=t}while(g.length>0)if(t=g.shift(),t.getName()=="blockquote"){for(o=new CKEDITOR.dom.documentFragment(n.document);t.getFirst();)o.append(t.getFirst().remove()),u.push(o.getLast());o.replace(t)}else u.push(t);for(e=n.document.createElement("blockquote"),e.insertBefore(u[0]);u.length>0;)t=u.shift(),e.append(t)}else if(et==CKEDITOR.TRISTATE_ON){for(nt=[],a={};t=it.getNextParagraph();){for(ut=null,v=null;t.getParent();){if(t.getParent().getName()=="blockquote"){ut=t.getParent(),v=t;break}t=t.getParent()}ut&&v&&!v.getCustomData("blockquote_moveout")&&(nt.push(v),CKEDITOR.dom.element.setMarker(a,v,"blockquote_moveout",!0))}for(CKEDITOR.dom.element.clearAllMarkers(a),tt=[],b=[],a={};nt.length>0;)r=nt.shift(),e=r.getParent(),r.getPrevious()?r.getNext()?(r.breakParent(r.getParent()),b.push(r.getNext())):r.remove().insertAfter(e):r.remove().insertBefore(e),e.getCustomData("blockquote_processed")||(b.push(e),CKEDITOR.dom.element.setMarker(a,e,"blockquote_processed",!0)),tt.push(r);for(CKEDITOR.dom.element.clearAllMarkers(a),s=b.length-1;s>=0;s--)e=b[s],i(e)&&e.remove();if(n.config.enterMode==CKEDITOR.ENTER_BR)for(ft=!0;tt.length;)if(r=tt.shift(),r.getName()=="div"){for(o=new CKEDITOR.dom.documentFragment(n.document),st=ft&&r.getPrevious()&&!(r.getPrevious().type==CKEDITOR.NODE_ELEMENT&&r.getPrevious().isBlockBoundary()),st&&o.append(n.document.createElement("br")),ht=r.getNext()&&!(r.getNext().type==CKEDITOR.NODE_ELEMENT&&r.getNext().isBlockBoundary());r.getFirst();)r.getFirst().remove().appendTo(o);ht&&o.append(n.document.createElement("br")),o.replace(r),ft=!1}}k.selectBookmarks(l),n.focus()}}};CKEDITOR.plugins.add("blockquote",{init:function(n){n.addCommand("blockquote",r),n.ui.addButton("Blockquote",{label:n.lang.blockquote,command:"blockquote"});n.on("selectionChange",t)},requires:["domiterator"]})})();