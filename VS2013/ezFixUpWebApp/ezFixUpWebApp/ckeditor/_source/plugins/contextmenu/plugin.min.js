CKEDITOR.plugins.add("contextmenu",{requires:["menu"],beforeInit:function(n){n.contextMenu=new CKEDITOR.plugins.contextMenu(n),n.addCommand("contextMenu",{exec:function(){n.contextMenu.show(n.document.getBody())}})}}),CKEDITOR.plugins.contextMenu=CKEDITOR.tools.createClass({$:function(n){this.id="cke_"+CKEDITOR.tools.getNextNumber(),this.editor=n,this._.listeners=[],this._.functionId=CKEDITOR.tools.addFunction(function(t){this._.panel.hide(),n.focus(),n.execCommand(t)},this)},_:{onMenu:function(n,t,i,r){var u=this._.menu,f=this.editor,e,o,c,s;u?(u.hide(),u.removeAll()):(u=this._.menu=new CKEDITOR.menu(f),u.onClick=CKEDITOR.tools.bind(function(n){var t=!0;u.hide(),CKEDITOR.env.ie&&u.onEscape(),n.onClick?n.onClick():n.command&&f.execCommand(n.command),t=!1},this),u.onEscape=function(){f.focus(),CKEDITOR.env.ie&&f.getSelection().unlock(!0)});var l=this._.listeners,h=this.editor.getSelection(),a=h&&h.getStartElement();for(u.onHide=CKEDITOR.tools.bind(function(){if(u.onHide=null,CKEDITOR.env.ie){var n=f.getSelection();n&&n.unlock()}this.onHide&&this.onHide()},this),e=0;e<l.length;e++)if(o=l[e](a,h),o)for(c in o)s=this.editor.getMenuItem(c),s&&(s.state=o[c],u.add(s));u.items.length&&u.show(n,t||(f.lang.dir=="rtl"?2:1),i,r)}},proto:{addTarget:function(n,t){var i,r,f,u;if(CKEDITOR.env.opera){n.on("mousedown",function(r){var f,u;if(r=r.data,r.$.button!=2){r.getKeystroke()==CKEDITOR.CTRL+1&&n.fire("contextmenu",r);return}t&&(r.$.ctrlKey||r.$.metaKey)||(f=r.getTarget(),i||(u=f.getDocument(),i=u.createElement("input"),i.$.type="button",u.getBody().append(i)),i.setAttribute("style","position:absolute;top:"+(r.$.clientY-2)+"px;left:"+(r.$.clientX-2)+"px;width:5px;height:5px;opacity:0.01"))});n.on("mouseup",function(t){i&&(i.remove(),i=undefined,n.fire("contextmenu",t.data))})}n.on("contextmenu",function(n){var i=n.data,u;if(!t||!(CKEDITOR.env.webkit?r:i.$.ctrlKey||i.$.metaKey)){CKEDITOR.env.ie&&(u=this.editor.getSelection(),u&&u.lock()),i.preventDefault();var f=i.getTarget().getDocument().getDocumentElement(),e=i.$.clientX,o=i.$.clientY;CKEDITOR.tools.setTimeout(function(){this._.onMenu(f,null,e,o)},0,this)}},this);if(CKEDITOR.env.webkit){f=function(n){r=n.data.$.ctrlKey||n.data.$.metaKey},u=function(){r=0};n.on("keydown",f);n.on("keyup",u);n.on("contextmenu",u)}},addListener:function(n){this._.listeners.push(n)},show:function(n,t,i,r){this.editor.focus();this._.onMenu(n||CKEDITOR.document.getDocumentElement(),t,i||0,r||0)}}});