CKEDITOR.plugins.add("richcombo",{requires:["floatpanel","listblock","button"],beforeInit:function(n){n.ui.addHandler(CKEDITOR.UI_RICHCOMBO,CKEDITOR.ui.richCombo.handler)}}),CKEDITOR.UI_RICHCOMBO=3,CKEDITOR.ui.richCombo=CKEDITOR.tools.createClass({$:function(n){CKEDITOR.tools.extend(this,n,{title:n.label,modes:{wysiwyg:1}});var t=this.panel||{};delete this.panel,this.id=CKEDITOR.tools.getNextNumber(),this.document=t&&t.parent&&t.parent.getDocument()||CKEDITOR.document,t.className=(t.className||"")+" cke_rcombopanel",this._={panelDefinition:t,items:{},state:CKEDITOR.TRISTATE_OFF}},statics:{handler:{create:function(n){return new CKEDITOR.ui.richCombo(n)}}},proto:{renderHtml:function(n){var t=[];return this.render(n,t),t.join("")},render:function(n,t){var i="cke_"+this.id,r=CKEDITOR.tools.addFunction(function(t){var i=this._,r;if(i.state!=CKEDITOR.TRISTATE_DISABLED){if(this.createPanel(n),i.on){i.panel.hide();return}i.committed||(i.list.commit(),i.committed=1),r=this.getValue(),r?i.list.mark(r):i.list.unmarkAll(),i.panel.showBlock(this.id,new CKEDITOR.dom.element(t),4)}},this),u={id:i,combo:this,focus:function(){var n=CKEDITOR.document.getById(i).getChild(1);n.focus()},execute:r},f;n.on("mode",function(){this.setState(this.modes[n.mode]?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED)},this);return f=CKEDITOR.tools.addFunction(function(n,t){n=new CKEDITOR.dom.event(n);var i=n.getKeystroke();switch(i){case 13:case 32:case 40:CKEDITOR.tools.callFunction(r,t);break;default:u.onkey(u,i)}n.preventDefault()}),t.push('<span class="cke_rcombo">',"<span id=",i),this.className&&t.push(' class="',this.className,' cke_off"'),t.push("><span class=cke_label>",this.label,'<\/span><a hidefocus=true title="',this.title,'" tabindex="-1" href="javascript:void(\'',this.label,"')\""),(CKEDITOR.env.opera||CKEDITOR.env.gecko&&CKEDITOR.env.mac)&&t.push(' onkeypress="return false;"'),CKEDITOR.env.gecko&&t.push(' onblur="this.style.cssText = this.style.cssText;"'),t.push(' onkeydown="CKEDITOR.tools.callFunction( ',f,', event, this );" onclick="CKEDITOR.tools.callFunction(',r,', this); return false;"><span><span class="cke_accessibility">'+(this.voiceLabel?this.voiceLabel+" ":"")+'<\/span><span id="'+i+'_text" class="cke_text cke_inline_label">'+this.label+"<\/span><\/span><span class=cke_openbutton><\/span><\/a><\/span><\/span>"),this.onRender&&this.onRender(),u},createPanel:function(n){if(!this._.panel){var u=this._.panelDefinition,f=u.parent||CKEDITOR.document.getBody(),i=new CKEDITOR.ui.floatPanel(n,f,u),r=i.addListBlock(this.id,this.multiSelect),t=this;i.onShow=function(){t.className&&this.element.getFirst().addClass(t.className+"_panel"),t.setState(CKEDITOR.TRISTATE_ON),r.focus(!t.multiSelect&&t.getValue()),t._.on=1,t.onOpen&&t.onOpen()},i.onHide=function(){t.className&&this.element.getFirst().removeClass(t.className+"_panel"),t.setState(CKEDITOR.TRISTATE_OFF),t._.on=0,t.onClose&&t.onClose()},i.onEscape=function(){i.hide(),t.document.getById("cke_"+t.id).getFirst().getNext().focus()},r.onClick=function(n,r){t.document.getWindow().focus(),t.onClick&&t.onClick.call(t,n,r),r?t.setValue(n,t._.items[n]):t.setValue(""),i.hide()},this._.panel=i,this._.list=r,i.getBlock(this.id).onHide=function(){t._.on=0,t.setState(CKEDITOR.TRISTATE_OFF)},this.init&&this.init()}},setValue:function(n,t){this._.value=n;var i=this.document.getById("cke_"+this.id+"_text");n||t?i.removeClass("cke_inline_label"):(t=this.label,i.addClass("cke_inline_label")),i.setHtml(typeof t!="undefined"?t:n)},getValue:function(){return this._.value||""},unmarkAll:function(){this._.list.unmarkAll()},mark:function(n){this._.list.mark(n)},hideItem:function(n){this._.list.hideItem(n)},hideGroup:function(n){this._.list.hideGroup(n)},showAll:function(){this._.list.showAll()},add:function(n,t,i){this._.items[n]=i||n,this._.list.add(n,t,i)},startGroup:function(n){this._.list.startGroup(n)},commit:function(){this._.list.commit()},setState:function(n){this._.state!=n&&(this.document.getById("cke_"+this.id).setState(n),this._.state=n)}}}),CKEDITOR.ui.prototype.addRichCombo=function(n,t){this.add(n,CKEDITOR.UI_RICHCOMBO,t)};