(function(){function n(n){function v(n){i.length>0||n.type==CKEDITOR.NODE_ELEMENT&&e.test(n.getName())&&!n.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(f,n,"selected_cell",!0),i.push(n))}for(var a=n.createBookmarks(),c=n.getRanges(),i=[],f={},u,o,s,h,l,t,r=0;r<c.length;r++)if(u=c[r],u.collapsed)o=u.getCommonAncestor(),s=o.getAscendant("td",!0)||o.getAscendant("th",!0),s&&i.push(s);else for(h=new CKEDITOR.dom.walker(u),h.guard=v;l=h.next();)t=l.getParent(),t&&e.test(t.getName())&&!t.getCustomData("selected_cell")&&(CKEDITOR.dom.element.setMarker(f,t,"selected_cell",!0),i.push(t));return CKEDITOR.dom.element.clearAllMarkers(f),n.selectBookmarks(a),i}function y(n){for(var i=n.cells,t=0;t<i.length;t++)i[t].innerHTML="",CKEDITOR.env.ie||new CKEDITOR.dom.element(i[t]).appendBogus()}function o(n,t){var i=n.getStartElement().getAscendant("tr"),r;i&&(r=i.clone(!0),r.insertBefore(i),y(t?r.$:i.$))}function u(t){var f,r,i,e,o;if(t instanceof CKEDITOR.dom.selection){for(f=n(t),r=[],i=0;i<f.length;i++)e=f[i].getParent(),r[e.$.rowIndex]=e;for(i=r.length;i>=0;i--)r[i]&&u(r[i])}else t instanceof CKEDITOR.dom.element&&(o=t.getAscendant("table"),o.$.rows.length==1?o.remove():t.remove())}function s(n,t){var s=n.getStartElement(),i=s.getAscendant("td",!0)||s.getAscendant("th",!0),e,r,u,f,o;if(i)for(e=i.getAscendant("table"),r=i.$.cellIndex,u=0;u<e.$.rows.length;u++)(f=e.$.rows[u],f.cells.length<r+1)||(i=new CKEDITOR.dom.element(f.cells[r].cloneNode(!1)),CKEDITOR.env.ie||i.appendBogus(),o=new CKEDITOR.dom.element(f.cells[r]),t?i.insertBefore(o):i.insertAfter(o))}function h(t){var f,i,o,e,r;if(t instanceof CKEDITOR.dom.selection)for(f=n(t),i=f.length;i>=0;i--)f[i]&&h(f[i]);else if(t instanceof CKEDITOR.dom.element)for(o=t.getAscendant("table"),e=t.$.cellIndex,i=o.$.rows.length-1;i>=0;i--){if(r=new CKEDITOR.dom.element(o.$.rows[i]),!e&&r.$.cells.length==1){u(r);continue}r.$.cells[e]&&r.$.removeChild(r.$.cells[e])}}function c(n,t){var u=n.getStartElement(),i=u.getAscendant("td",!0)||u.getAscendant("th",!0),r;i&&(r=i.clone(),CKEDITOR.env.ie||r.appendBogus(),t?r.insertBefore(i):r.insertAfter(i))}function l(t){var r,i;if(t instanceof CKEDITOR.dom.selection)for(r=n(t),i=r.length-1;i>=0;i--)l(r[i]);else t instanceof CKEDITOR.dom.element&&(t.getParent().getChildCount()==1?t.getParent().remove():t.remove())}function p(n){var t=n.getBogus();t&&t.remove(),n.trim()}function r(n,t){var i=new CKEDITOR.dom.range(n.getDocument());i["moveToElementEdit"+(t?"End":"Start")](n)||(i.selectNodeContents(n),i.collapse(t?!1:!0)),i.select(!0)}function f(n){for(var s=n.$.rows,t=-1,i=[],u,e,o,c,l,f,h,r=0;r<s.length;r++)for(t++,i[t]||(i[t]=[]),u=-1,e=0;e<s[r].cells.length;e++){for(o=s[r].cells[e],u++;i[t][u];)u++;for(c=isNaN(o.colSpan)?1:o.colSpan,l=isNaN(o.rowSpan)?1:o.rowSpan,f=0;f<l;f++)for(i[t+f]||(i[t+f]=[]),h=0;h<c;h++)i[t+f][u+h]=s[r].cells[e];u+=c-1}return i}function t(n,t,i){var u=n[t],r;if(typeof i=="undefined")return u;for(r=0;u&&r<u.length;r++){if(i.is&&u[r]==i.$)return r;if(r==i)return new CKEDITOR.dom.element(u[r])}return i.is?-1:null}function w(n,t,i){for(var f=[],u,r=0;r<n.length;r++)if(u=n[r],typeof i=="undefined")f.push(u[t]);else{if(i.is&&u[t]==i.$)return r;if(r==i)return new CKEDITOR.dom.element(u[t])}return typeof i=="undefined"?f:i.is?-1:null}function i(i,r,u){var h=n(i),g,w,s,d,tt,it,rt;if((r?h.length!=1:h.length<2)||(g=i.getCommonAncestor())&&g.type==CKEDITOR.NODE_ELEMENT&&g.is("table"))return!1;var o,e=h[0],ut=e.getAscendant("table"),l=f(ut),ht=l.length,ct=l[0].length,c=e.getParent().$.rowIndex,y=t(l,c,e);if(r){try{w=l[r=="up"?c-1:r=="down"?c+1:c][r=="left"?y-1:r=="right"?y+1:y]}catch(yt){return!1}if(!w||e.$==w)return!1;h[r=="up"||r=="left"?"unshift":"push"](new CKEDITOR.dom.element(w))}var lt=e.getDocument(),ft=c,a=0,v=0,b=!u&&new CKEDITOR.dom.documentFragment(lt),et=0;for(s=0;s<h.length;s++){o=h[s];var at=o.getParent(),nt=o.getFirst(),ot=o.$.colSpan,st=o.$.rowSpan,k=at.$.rowIndex,vt=t(l,k,o);et+=ot*st,v=Math.max(v,vt-y+ot),a=Math.max(a,k-c+st),u||((p(o),o.getChildren().count())&&(k==ft||!nt||nt.isBlockBoundary&&nt.isBlockBoundary({br:1})||(d=b.getLast(CKEDITOR.dom.walker.whitespaces(!0)),!d||d.is&&d.is("br")||b.append(new CKEDITOR.dom.element("br"))),o.moveChildren(b)),s?o.remove():o.setHtml("")),ft=k}if(u)return a*v==et;for(b.moveChildren(e),CKEDITOR.env.ie||e.appendBogus(),v>=ct?e.removeAttribute("rowSpan"):e.$.rowSpan=a,a>=ht?e.removeAttribute("colSpan"):e.$.colSpan=v,tt=new CKEDITOR.dom.nodeList(ut.$.rows),it=tt.count(),s=it-1;s>=0;s--)if(rt=tt.getItem(s),!rt.$.cells.length){rt.remove(),it++;continue}return e}function a(i,r){var g=n(i),o,k,h,c,d,v;if(g.length>1)return!1;if(r)return!0;var e=g[0],l=e.getParent(),nt=l.getAscendant("table"),y=f(nt),p=l.$.rowIndex,tt=t(y,p,e),w=e.$.rowSpan,u,s,a,b;if(w>1){for(s=Math.ceil(w/2),a=Math.floor(w/2),b=p+s,o=new CKEDITOR.dom.element(nt.$.rows[b]),k=t(y,b),u=e.clone(),c=0;c<k.length;c++)if(h=k[c],h.parentNode==o.$&&c>tt){u.insertBefore(new CKEDITOR.dom.element(h));break}else h=null;h||o.append(u,!0)}else for(a=s=1,o=l.clone(),o.insertAfter(l),o.append(u=e.clone()),d=t(y,p),v=0;v<d.length;v++)d[v].rowSpan++;return CKEDITOR.env.ie||u.appendBogus(),e.$.rowSpan=s,u.$.rowSpan=a,s==1&&e.removeAttribute("rowSpan"),a==1&&u.removeAttribute("rowSpan"),u}function v(i,r){var a=n(i),l,h;if(a.length>1)return!1;if(r)return!0;var u=a[0],v=u.getParent(),p=v.getAscendant("table"),y=f(p),b=v.$.rowIndex,k=t(y,b,u),c=u.$.colSpan,e,o,s;if(c>1)o=Math.ceil(c/2),s=Math.floor(c/2);else for(s=o=1,l=w(y,k),h=0;h<l.length;h++)l[h].colSpan++;return e=u.clone(),e.insertAfter(u),CKEDITOR.env.ie||e.appendBogus(),u.$.colSpan=o,e.$.colSpan=s,o==1&&u.removeAttribute("colSpan"),s==1&&e.removeAttribute("colSpan"),e}var e=/^(?:td|th)$/,b={thead:1,tbody:1,tfoot:1,td:1,tr:1,th:1};CKEDITOR.plugins.tabletools={init:function(t){var f=t.lang.table;t.addCommand("cellProperties",new CKEDITOR.dialogCommand("cellProperties")),CKEDITOR.dialog.add("cellProperties",this.path+"dialogs/tableCell.js"),t.addCommand("tableDelete",{exec:function(n){var t=n.getSelection(),u=t&&t.getStartElement(),i=u&&u.getAscendant("table",!0),r;i&&(t.selectElement(i),r=t.getRanges()[0],r.collapse(),t.selectRanges([r]),i.getParent().getChildCount()==1?i.getParent().remove():i.remove())}}),t.addCommand("rowDelete",{exec:function(n){var t=n.getSelection();u(t)}}),t.addCommand("rowInsertBefore",{exec:function(n){var t=n.getSelection();o(t,!0)}}),t.addCommand("rowInsertAfter",{exec:function(n){var t=n.getSelection();o(t)}}),t.addCommand("columnDelete",{exec:function(n){var t=n.getSelection();h(t)}}),t.addCommand("columnInsertBefore",{exec:function(n){var t=n.getSelection();s(t,!0)}}),t.addCommand("columnInsertAfter",{exec:function(n){var t=n.getSelection();s(t)}}),t.addCommand("cellDelete",{exec:function(n){var t=n.getSelection();l(t)}}),t.addCommand("cellMerge",{exec:function(n){r(i(n.getSelection()),!0)}}),t.addCommand("cellMergeRight",{exec:function(n){r(i(n.getSelection(),"right"),!0)}}),t.addCommand("cellMergeDown",{exec:function(n){r(i(n.getSelection(),"down"),!0)}}),t.addCommand("cellVerticalSplit",{exec:function(n){r(a(n.getSelection()))}}),t.addCommand("cellHorizontalSplit",{exec:function(n){r(v(n.getSelection()))}}),t.addCommand("cellInsertBefore",{exec:function(n){var t=n.getSelection();c(t,!0)}}),t.addCommand("cellInsertAfter",{exec:function(n){var t=n.getSelection();c(t)}}),t.addMenuItems&&t.addMenuItems({tablecell:{label:f.cell.menu,group:"tablecell",order:1,getItems:function(){var r=t.getSelection(),u=n(r);return{tablecell_insertBefore:CKEDITOR.TRISTATE_OFF,tablecell_insertAfter:CKEDITOR.TRISTATE_OFF,tablecell_delete:CKEDITOR.TRISTATE_OFF,tablecell_merge:i(r,null,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_right:i(r,"right",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_merge_down:i(r,"down",!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_vertical:a(r,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_split_horizontal:v(r,!0)?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED,tablecell_properties:u.length>0?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED}}},tablecell_insertBefore:{label:f.cell.insertBefore,group:"tablecell",command:"cellInsertBefore",order:5},tablecell_insertAfter:{label:f.cell.insertAfter,group:"tablecell",command:"cellInsertAfter",order:10},tablecell_delete:{label:f.cell.deleteCell,group:"tablecell",command:"cellDelete",order:15},tablecell_merge:{label:f.cell.merge,group:"tablecell",command:"cellMerge",order:16},tablecell_merge_right:{label:f.cell.mergeRight,group:"tablecell",command:"cellMergeRight",order:17},tablecell_merge_down:{label:f.cell.mergeDown,group:"tablecell",command:"cellMergeDown",order:18},tablecell_split_horizontal:{label:f.cell.splitHorizontal,group:"tablecell",command:"cellHorizontalSplit",order:19},tablecell_split_vertical:{label:f.cell.splitVertical,group:"tablecell",command:"cellVerticalSplit",order:20},tablecell_properties:{label:f.cell.title,group:"tablecellproperties",command:"cellProperties",order:21},tablerow:{label:f.row.menu,group:"tablerow",order:1,getItems:function(){return{tablerow_insertBefore:CKEDITOR.TRISTATE_OFF,tablerow_insertAfter:CKEDITOR.TRISTATE_OFF,tablerow_delete:CKEDITOR.TRISTATE_OFF}}},tablerow_insertBefore:{label:f.row.insertBefore,group:"tablerow",command:"rowInsertBefore",order:5},tablerow_insertAfter:{label:f.row.insertAfter,group:"tablerow",command:"rowInsertAfter",order:10},tablerow_delete:{label:f.row.deleteRow,group:"tablerow",command:"rowDelete",order:15},tablecolumn:{label:f.column.menu,group:"tablecolumn",order:1,getItems:function(){return{tablecolumn_insertBefore:CKEDITOR.TRISTATE_OFF,tablecolumn_insertAfter:CKEDITOR.TRISTATE_OFF,tablecolumn_delete:CKEDITOR.TRISTATE_OFF}}},tablecolumn_insertBefore:{label:f.column.insertBefore,group:"tablecolumn",command:"columnInsertBefore",order:5},tablecolumn_insertAfter:{label:f.column.insertAfter,group:"tablecolumn",command:"columnInsertAfter",order:10},tablecolumn_delete:{label:f.column.deleteColumn,group:"tablecolumn",command:"columnDelete",order:15}}),t.contextMenu&&t.contextMenu.addListener(function(n){if(!n)return null;while(n){if(n.getName()in b)return{tablecell:CKEDITOR.TRISTATE_OFF,tablerow:CKEDITOR.TRISTATE_OFF,tablecolumn:CKEDITOR.TRISTATE_OFF};n=n.getParent()}return null})},getSelectedCells:n},CKEDITOR.plugins.add("tabletools",CKEDITOR.plugins.tabletools)})();