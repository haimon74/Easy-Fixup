(function(){function n(n){var t=n.getSelection();this.contents=n.getSnapshot(),this.bookmarks=t&&t.createBookmarks2(!0),CKEDITOR.env.ie&&(this.contents=this.contents.replace(/\s+_cke_expando=".*?"/g,""))}function i(n){this.editor=n,this.reset()}var t;CKEDITOR.plugins.add("undo",{requires:["selection","wysiwygarea"],init:function(n){function r(n){t.enabled&&n.data.command.canUndo!==!1&&t.save()}var t=new i(n),u=n.addCommand("undo",{exec:function(){t.undo()&&(n.selectionChange(),this.fire("afterUndo"))},state:CKEDITOR.TRISTATE_DISABLED,canUndo:!1}),f=n.addCommand("redo",{exec:function(){t.redo()&&(n.selectionChange(),this.fire("afterRedo"))},state:CKEDITOR.TRISTATE_DISABLED,canUndo:!1});t.onChange=function(){u.setState(t.undoable()?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED),f.setState(t.redoable()?CKEDITOR.TRISTATE_OFF:CKEDITOR.TRISTATE_DISABLED)};n.on("beforeCommandExec",r);n.on("afterCommandExec",r);n.on("saveSnapshot",function(){t.save()});n.on("contentDom",function(){n.document.on("keydown",function(n){n.data.$.ctrlKey||n.data.$.metaKey||t.type(n)})});n.on("beforeModeUnload",function(){n.mode=="wysiwyg"&&t.save(!0)});n.on("mode",function(){t.enabled=n.mode=="wysiwyg",t.onChange()});n.ui.addButton("Undo",{label:n.lang.undo,command:"undo"}),n.ui.addButton("Redo",{label:n.lang.redo,command:"redo"}),n.resetUndo=function(){t.reset(),n.fire("saveSnapshot")}}}),t=/\b(?:href|src|name)="[^"]*?"/gi,n.prototype={equals:function(n,i){var s=this.contents,h=n.contents,r,u,f,e,o;if(CKEDITOR.env.ie&&(CKEDITOR.env.ie7Compat||CKEDITOR.env.ie6Compat)&&(s=s.replace(t,""),h=h.replace(t,"")),s!=h)return!1;if(i)return!0;if(r=this.bookmarks,u=n.bookmarks,r||u){if(!r||!u||r.length!=u.length)return!1;for(f=0;f<r.length;f++)if(e=r[f],o=u[f],e.startOffset!=o.startOffset||e.endOffset!=o.endOffset||!CKEDITOR.tools.arrayCompare(e.start,o.start)||!CKEDITOR.tools.arrayCompare(e.end,o.end))return!1}return!0}};var r={8:1,46:1},f={16:1,17:1,18:1},u={37:1,38:1,39:1,40:1};i.prototype={type:function(t){var i=t&&t.data.getKey(),h=i in f,e=i in r,c=this.lastKeystroke in r,l=e&&i==this.lastKeystroke,s=i in u,a=this.lastKeystroke in u,v=!e&&!s,y=e&&!l,p=!(h||this.typing)||v&&(c||a),o;(p||y)&&(o=new n(this.editor),CKEDITOR.tools.setTimeout(function(){var n=this.editor.getSnapshot();CKEDITOR.env.ie&&(n=n.replace(/\s+_cke_expando=".*?"/g,"")),o.contents!=n&&(this.typing=!0,this.save(!1,o,!1)||this.snapshots.splice(this.index+1,this.snapshots.length-this.index-1),this.hasUndo=!0,this.hasRedo=!1,this.typesCount=1,this.modifiersCount=1,this.onChange())},0,this)),this.lastKeystroke=i,e?(this.typesCount=0,this.modifiersCount++,this.modifiersCount>25&&(this.save(!1,null,!1),this.modifiersCount=1)):s||(this.modifiersCount=0,this.typesCount++,this.typesCount>25&&(this.save(!1,null,!1),this.typesCount=1))},reset:function(){this.lastKeystroke=0,this.snapshots=[],this.index=-1,this.limit=this.editor.config.undoStackSize,this.currentImage=null,this.hasUndo=!1,this.hasRedo=!1,this.resetType()},resetType:function(){this.typing=!1,delete this.lastKeystroke,this.typesCount=0,this.modifiersCount=0},fireChange:function(){this.hasUndo=!!this.getNextImage(!0),this.hasRedo=!!this.getNextImage(!1),this.resetType(),this.onChange()},save:function(t,i,r){var u=this.snapshots;return(i||(i=new n(this.editor)),this.currentImage&&i.equals(this.currentImage,t))?!1:(u.splice(this.index+1,u.length-this.index-1),u.length==this.limit&&u.shift(),this.index=u.push(i)-1,this.currentImage=i,r!==!1&&this.fireChange(),!0)},restoreImage:function(n){if(this.editor.loadSnapshot(n.contents),n.bookmarks)this.editor.getSelection().selectBookmarks(n.bookmarks);else if(CKEDITOR.env.ie){var t=this.editor.document.getBody().$.createTextRange();t.collapse(!0),t.select()}this.index=n.index,this.currentImage=n,this.fireChange()},getNextImage:function(n){var r=this.snapshots,u=this.currentImage,i,t;if(u)if(n){for(t=this.index-1;t>=0;t--)if(i=r[t],!u.equals(i,!0))return i.index=t,i}else for(t=this.index+1;t<r.length;t++)if(i=r[t],!u.equals(i,!0))return i.index=t,i;return null},redoable:function(){return this.enabled&&this.hasRedo},undoable:function(){return this.enabled&&this.hasUndo},undo:function(){if(this.undoable()){this.save(!0);var n=this.getNextImage(!0);if(n)return this.restoreImage(n),!0}return!1},redo:function(){if(this.redoable()&&(this.save(!0),this.redoable())){var n=this.getNextImage(!1);if(n)return this.restoreImage(n),!0}return!1}}})(),CKEDITOR.config.undoStackSize=20;